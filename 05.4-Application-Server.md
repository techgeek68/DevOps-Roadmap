# Application Servers & Apache Tomcat

---

**What is an Application Server?**
- An application server is a software platform providing runtime services for dynamic application code (e.g., Java Servlets, JSP, WebSocket endpoints, REST APIs). It abstracts:
  - Business logic execution (transactions, security integration)
  - Resource management (thread pools, connection pools, clustering hooks)
  - Standard APIs (Servlet, JSP, WebSocket, Expression Language; in full Java/Jakarta EE servers: JPA, JMS, CDI, JTA)
  - Deployment model (WAR, EAR, exploded or packaged)

Examples (lightweight vs. full profile):
- Lightweight / Servlet containers: Apache Tomcat, Jetty, Undertow
- Full Jakarta EE / Enterprise: WildFly, Payara, WebLogic, WebSphere

**Web Server vs. Application Server**

| Feature        | Web Server (HTTPD, Nginx)                        | Application Server (Tomcat, WildFly)                |
|----------------|--------------------------------------------------|-----------------------------------------------------|
| Primary Role   | Static content, reverse proxy, TLS termination   | Dynamic request execution (Servelts/JSP), APIs      |
| Execution Model| File streaming                                   | Managed components (Servlet lifecycle)              |
| Protocols      | HTTP/HTTPS (+ optional FastCGI, gRPC proxy)      | HTTP/HTTPS + implementation of Jakarta EE APIs      |
| Caching        | Strong static cache, edge friendliness           | Caches objects in heap (depends on app design)      |
| Scaling        | Horizontal (stateless)                           | Horizontal + session handling (sticky or replicated)|
| Use Case       | Front tier, static, proxy, load balancing        | Backend dynamic logic                               |

> Web servers specialise in efficient HTTP request handling and static file delivery; application servers host and execute code that renders dynamic responses.

---

**Apache Tomcat**

**What is Tomcat?**
  - Open-source Java Servlet/JSP container
  - Implements: Servlet, JSP, WebSocket, EL, annotations
  - Not a full Jakarta EE stack (no built-in EJB/JPA/JMS/JTA); integrate frameworks (Spring, Hibernate) at app layer

**Core Internal Components**
  - Coyote: Protocol handler (HTTP/1.1, HTTP/2 with upgrade, AJP if enabled)
  - Catalina: Servlet container (deployment, lifecycle, mapping, filters)
  - Jasper: JSP compiler (JSP→Java servlet class→bytecode)
  - Realm: Authentication/authorisation integration (MemoryRealm, JDBCRealm, JNDIRealm)
  - Connectors: Network endpoints (HTTP, HTTPS, AJP)
  - Executor: Shared thread pool (optional) for connectors & servlet threads

**Request Flow**
```
Client → Connector (Coyote) → Catalina Mapping → Filter Chain → Servlet/JSP → Response Commit → Output via Coyote
```

 - Tomcat Request Handling:
```
+-------------------------------+      +-------------------------------+      +--------------------------------+
|      Client (Browser)         |<---->|  Coyote (HTTP connector)      |<---->|   Servlet engine (Catalina)    |
|  HTTP request                 |      |  Acceptor threads             |      |  Servlets/JSP processing       |
|  HTTP response                |      |  Worker threads               |      |                                |
|                               |      |  SSL/TLS encryption (if HTTPS)|      |                                |
+-------------------------------+      +-------------------------------+      +--------------------------------+
                                                                                 |                           |
                                                                                 |                           |
                                                                                 v                           v
                                                                                +-------------------------------+
                                                                                | Jasper                        |
                                                                                | (JSP engine, if JSP)          |
                                                                                | JSP compilation (if JSP file) |
                                                                                | and Java bytecode delivery    |
                                                                                | for Catalina processing       |
                                                                                +-------------------------------+
```
  - Client (Browser): sends HTTP request, receives HTTP response.
  - Coyote (HTTP Connector): Listens for incoming connections, SSL/TLS support, and hands requests to Catalina.
  - Catalina (Servlet Engine): manages Servlet lifecycle; delegates JSPs to Jasper.
  - Jasper (JSP Engine): compiles JSPs to Servlets (bytecode) returned to Catalina.

---

**Environment & Prerequisites**

| Item            | Recommendation |
|-----------------|----------------|
| OS              | RHEL / CentOS / Rocky / AlmaLinux / Debian / Ubuntu |
| Java Version    | Use latest LTS (e.g., OpenJDK 21) |
| User Separation | Run Tomcat as non-root (e.g., `tomcat` user) |
| Firewall        | Restrict inbound to required ports only |
| SELinux/AppArmor| Configure policies rather than disabling |


- Set hostname:
```
 sudo hostnamectl set-hostname tomcatserver.devopsclass.com
 sudo exec bash
```

- Configure network:
```
  nmtui
```

- Install Java (RHEL family):
```
sudo dnf list *openjdk*
sudo dnf -y install java-21-openjdk
```
- Verify:
```
java -version
```

- Recommended Variables (add to `.bashrc` or system profile):
```
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
export CATALINA_HOME=/opt/tomcat
export PATH=$PATH:$CATALINA_HOME/bin
```

**Or** Create aliases:
```
vim ~/.bashrc
```
Add:
```
alias startup='/home/cnode/apache-tomcat-9.0.106/bin/startup.sh'
alias shutdown='/home/cnode/apache-tomcat-9.0.106/bin/shutdown.sh'
```

---

**Install Tomcat**:

| Methods         | Pros | Cons |
|----------------|------|------|
| tar.gz manual  | Full control, multiple versions side-by-side | Manual updates, no automatic service management |
| OS packages    | Easy updates via package manager | Might lag latest upstream, opinionated paths |
| Container image| Fast portability, immutable layering | Requires container orchestration hygiene |
| Configuration mgmt (Ansible) | Repeatable, versionable | Setup complexity |


**Transfer a previously downloaded archive:**
```
  scp apache-tomcat-11.0.8-fulldocs.tar.gz user_name@<IP_Addr>:/opt
```

**tar.gz Manual Install**
  - Visit [Apache Tomcat](https://tomcat.apache.org/) to find a download link.
    
<img width="1446" height="567" alt="Screenshot 2025-11-20 at 12 48 16 PM" src="https://github.com/user-attachments/assets/8fc7e1c4-c8fb-4904-bc85-36db28486fa5" />

```
sudo wget https://dlcdn.apache.org/tomcat/tomcat-11/v11.0.14/bin/apache-tomcat-11.0.14.tar.gz

tar -zxvf apache-tomcat-9.0.106.tar.gz

sudo mv apache-tomcat-9.0.106 /opt/tomcat

sudo useradd -r -s /bin/false tomcat

sudo chown -R tomcat:tomcat /opt/tomcat
```

**Directory Layout**
```
sudo tree tomcat
```
```
/opt/tomcat            (CATALINA_HOME)
/opt/tomcat/conf       (server.xml, web.xml)
/opt/tomcat/logs
/opt/tomcat/webapps    (deployed WARs)
/opt/tomcat/temp
/opt/tomcat/work       (JSP compilation)
/opt/tomcat/lib        (shared libs if needed)
```
> Avoid modifying default `webapps` for production; deploy only required WARs. Remove sample apps (docs, examples, manager) when not needed.


**Running Tomcat**
- Start/Stop scripts:
```
cd /opt/apache
```
```
sudo ./bin/startup.sh
```

- Check if 8080 is listening:
```
  netstat -tnl | grep 8080
```

<img width="988" height="237" alt="Screenshot 2025-11-20 at 1 20 56 PM" src="https://github.com/user-attachments/assets/00ac68c2-cdb5-40ba-bfa6-d45e125839ab" />


```
sudo ./shutdown.sh
```

---
**Start Automatically on Reboot (rc.local)**
> Note: rc.local must exist and be executable.
```
vim /etc/rc.d/rc.local
```
Add full path to startup script:
```
/home/cnode/apache-tomcat-9.0.106/bin/startup.sh
```
Permissions:
```
chmod u+x /etc/rc.d/rc.local
```

---

## Change Tomcat Port
Check if the desired port (e.g., 5080) is free:
```
netstat -tnl | grep 5080
```

Edit server.xml:
```
cd /home/cnode/apache-tomcat-9.0.106/conf
vim server.xml
```
Find Connector and update:
```
<Connector port="5080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" />
```

Open firewall:
```
firewall-cmd --permanent --add-port=5080/tcp
firewall-cmd --reload
```

---

## Secure Remote Access to Manager/Host-Manager
By default, access is restricted to localhost via RemoteAddrValve.

Host Manager context.xml:
```
cd /home/cnode/apache-tomcat-9.0.106/webapps/host-manager/META-INF
vim context.xml
```
Allow a specific IP (example 10.10.5.5):
```
<Context antiResourceLocking="false" privileged="true">
  <Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.10\.5\.5" />
</Context>
```

To allow a subnet (example 192.168.1.x):
```
allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|192\.168\.1\.\d+"
```

Manager app has a similar file:
```
/home/cnode/apache-tomcat-9.0.106/webapps/manager/META-INF/context.xml
```

Note: Commenting the Valve removes IP restriction but is a security risk:
```
<!--
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" />
-->
```

---

## Create Roles and Users (tomcat-users.xml)
```
cd /home/cnode/apache-tomcat-9.0.106/conf
sudo vim tomcat-users.xml
```
Add roles:
```
<role rolename="manager-gui"/>
<role rolename="manager-script"/>
<role rolename="manager-jmx"/>
<role rolename="manager-status"/>
```
Add a user and assign roles:
```
<user username="admin" password="devops"
      roles="manager-gui,manager-script,manager-jmx,manager-status"/>
```

Reload Tomcat to apply:
```
shutdown.sh
startup.sh
```

---

## Verify
Access remotely (use your server IP and port):
```
http://10.10.5.4:5080
```

Expected landing page text:
```
If you're seeing this, you've successfully installed Tomcat. Congratulations!
```

Open the Manager App and log in with the configured credentials:
```
http://10.10.5.4:5080/manager/html
```

---

## Quick Reference: Host-Manager vs Manager context.xml
- host-manager/META-INF/context.xml
  - Purpose: Configure Host Manager (manage virtual hosts).
  - Scope: Server-wide host administration.

- manager/META-INF/context.xml
  - Purpose: Configure Manager App (manage webapps).
  - Scope: Deploy/undeploy/start/stop applications; runtime controls.
